# Deploying AgriSupply Backend to Render

## Quick Deployment Steps

### 1. Prepare Your Repository

Make sure your code is pushed to GitHub:

```bash
git add .
git commit -m "Add Render deployment configuration"
git push origin main
```

### 2. Create Render Account

1. Go to [render.com](https://render.com)
2. Sign up with GitHub
3. Authorize Render to access your repositories

### 3. Create New Web Service

1. Click **"New +"** → **"Web Service"**
2. Connect your GitHub repository: **AgriSupply**
3. Configure the service:
   - **Name**: `agrisupply-backend`
   - **Region**: Choose closest to your users (e.g., Frankfurt for Europe, Singapore for Asia)
   - **Branch**: `main`
   - **Root Directory**: `backend`
   - **Environment**: `Node`
   - **Build Command**: `npm install`
   - **Start Command**: `npm start`
   - **Plan**: Free

### 4. Add Environment Variables

In the Render dashboard, go to **Environment** tab and add these variables:

**Required Variables:**
```
SUPABASE_URL=https://ugrraxmjvbujpdzfsvzt.supabase.co
SUPABASE_ANON_KEY=<your-supabase-anon-key>
SUPABASE_SERVICE_ROLE_KEY=<your-supabase-service-role-key>
```

**Optional but Recommended:**
```
OPENAI_API_KEY=<your-openai-key>
MTN_API_KEY=<your-mtn-key>
MTN_API_SECRET=<your-mtn-secret>
MTN_SUBSCRIPTION_KEY=<your-mtn-subscription-key>
AIRTEL_API_KEY=<your-airtel-key>
AIRTEL_API_SECRET=<your-airtel-secret>
FLUTTERWAVE_PUBLIC_KEY=<your-flw-public-key>
FLUTTERWAVE_SECRET_KEY=<your-flw-secret-key>
FLUTTERWAVE_ENCRYPTION_KEY=<your-flw-encryption-key>
GOOGLE_CLIENT_ID=<your-google-client-id>
GOOGLE_CLIENT_SECRET=<your-google-client-secret>
FIREBASE_PROJECT_ID=<your-firebase-project-id>
FIREBASE_PRIVATE_KEY=<your-firebase-private-key>
FIREBASE_CLIENT_EMAIL=<your-firebase-client-email>
```

**Auto-configured Variables:**
```
NODE_ENV=production
PORT=3000
API_VERSION=v1
JWT_SECRET=<auto-generated>
JWT_REFRESH_SECRET=<auto-generated>
```

### 5. Get Your Supabase Keys

1. Go to [Supabase Dashboard](https://app.supabase.com)
2. Select your project: **ugrraxmjvbujpdzfsvzt**
3. Go to **Settings** → **API**
4. Copy:
   - **Project URL** (for SUPABASE_URL)
   - **anon public** key (for SUPABASE_ANON_KEY)
   - **service_role** key (for SUPABASE_SERVICE_ROLE_KEY)

### 6. Configure Callback URLs

After deployment, you'll get a URL like: `https://agrisupply-backend.onrender.com`

Update these environment variables with your Render URL:

```
MTN_CALLBACK_URL=https://agrisupply-backend.onrender.com/api/v1/payments/mtn/callback
AIRTEL_CALLBACK_URL=https://agrisupply-backend.onrender.com/api/v1/payments/airtel/callback
```

### 7. Deploy

Click **"Create Web Service"**

Render will:
- Clone your repository
- Install dependencies
- Start your app
- Provide a public URL

### 8. Verify Deployment

Once deployed, visit:
```
https://agrisupply-backend.onrender.com/health
```

You should see:
```json
{
  "success": true,
  "message": "AgriSupply API is running",
  "timestamp": "2026-02-10T...",
  "environment": "production",
  "version": "v1"
}
```

### 9. Update Mobile App Configuration

Update the API URL in your Flutter app:

**File**: `mobile/lib/config/app_config.dart`

Change:
```dart
static const String apiBaseUrl = 'http://localhost:3000/api';
```

To:
```dart
static const String apiBaseUrl = 'https://agrisupply-backend.onrender.com/api';
```

### 10. Test the API

Test authentication:
```bash
curl -X POST https://agrisupply-backend.onrender.com/api/v1/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@example.com",
    "password": "Test123!",
    "fullName": "Test User",
    "phone": "+256700000000",
    "role": "buyer"
  }'
```

## Important Notes

### Free Tier Limitations

- **Spin Down**: Apps on free tier spin down after 15 minutes of inactivity
- **Spin Up**: First request after spin down takes 30-60 seconds
- **Solution**: Upgrade to paid plan ($7/month) for always-on service

### Auto-Deploy

Render auto-deploys when you push to the `main` branch. To disable:
- Go to **Settings** → **Build & Deploy**
- Toggle off **Auto-Deploy**

### Custom Domain

To use your own domain:
1. Go to **Settings** → **Custom Domain**
2. Add your domain (e.g., `api.agrisupply.com`)
3. Update DNS records as shown
4. Wait for SSL certificate (automatic)

### Monitoring

- **Logs**: View real-time logs in Render dashboard
- **Metrics**: Check CPU, memory usage, and response times
- **Alerts**: Set up email alerts for failures

## Troubleshooting

### Build Fails

Check the build logs for errors:
- Missing dependencies in package.json
- Node version mismatch (requires Node 18+)

### App Crashes

Check runtime logs:
- Missing environment variables
- Database connection errors
- Invalid Supabase credentials

### Slow Response

Free tier apps spin down after inactivity:
- First request after spin down is slow (30-60s)
- Subsequent requests are fast
- Upgrade to paid plan for always-on

### Database Connection Issues

Verify:
- SUPABASE_URL is correct
- SUPABASE_SERVICE_ROLE_KEY is valid
- Supabase project is not paused
- RLS policies allow access

## Next Steps

After successful deployment:

1. ✅ Test all API endpoints
2. ✅ Update mobile app config
3. ✅ Run SQL fixes in Supabase (fix_profile_creation.sql)
4. ✅ Test signup/login flow
5. ✅ Configure payment provider webhooks
6. ✅ Set up monitoring and alerts
7. ✅ Consider upgrading to paid plan

## Support

- **Render Docs**: https://render.com/docs
- **Render Status**: https://status.render.com
- **Community**: https://community.render.com
